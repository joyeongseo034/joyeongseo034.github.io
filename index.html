<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¸ìƒë„¤ì»· 2x2 + Firebase + QR</title>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;padding:16px;text-align:center}
video{width:100%;max-width:400px;border-radius:12px;background:#000;display:none}
canvas{display:block;width:100%;max-width:400px;margin:12px 0;border-radius:12px;background:#fff}
.controls,.thumbs,.selects,.qr-wrap{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;justify-content:center}
button{padding:12px 20px;border:0;border-radius:10px;font-size:18px;cursor:pointer}
button.primary{background:#ffd166;color:#111;font-weight:600}
#startBtn{background:#06d6a0;color:#111;font-weight:700;font-size:22px;padding:20px 32px;margin-top:80px}
.thumbs img,.selects img{width:70px;height:70px;object-fit:cover;border:2px solid transparent;border-radius:6px;cursor:pointer}
.selected{border-color:#ffd166}
#qrcodeCanvas{background:#fff;padding:4px;border-radius:6px}
</style>
</head>
<body>

<h2>ì¸ìƒë„¤ì»· 2x2 + Firebase + QR</h2>

<!-- Safariì—ì„œ ë°˜ë“œì‹œ í•„ìš”: ì‹œì‘ ë²„íŠ¼ -->
<button id="startBtn">ğŸ“¸ ì¹´ë©”ë¼ ì‹œì‘</button>

<video id="video" autoplay playsinline muted></video>

<div class="controls" style="display:none" id="controls">
  <button id="switchBtn">ì¹´ë©”ë¼ ì „í™˜</button>
  <button id="snapBtn" class="primary">ì‚¬ì§„ ì°ê¸°</button>
</div>

<h3 style="display:none" id="shotsTitle">ì°ì€ ì‚¬ì§„ (ìµœëŒ€ 6ì¥)</h3>
<div class="thumbs" id="thumbs"></div>

<h3 style="display:none" id="selectTitle">ì„ íƒí•œ 4ì¥</h3>
<div class="selects" id="selects"></div>
<button id="makeStrip" class="primary" style="display:none">ìŠ¤íŠ¸ë¦½ ë§Œë“¤ê¸°</button>

<canvas id="strip" style="display:none"></canvas>

<div class="qr-wrap" style="margin-top:12px;display:none" id="qrWrap">
  <button id="qrBtn">QR ìƒì„±</button>
  <canvas id="qrcodeCanvas"></canvas>
</div>

<button id="downloadBtn" class="primary" style="margin-top:12px;display:none">ë‹¤ìš´ë¡œë“œ</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";

// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyAbtYXrRGh2ncLrIdePePDsEdRknn3iHuo",
  authDomain: "photobooth-93cef.firebaseapp.com",
  projectId: "photobooth-93cef",
  storageBucket: "photobooth-93cef.appspot.com",
  messagingSenderId: "758521835109",
  appId: "1:758521835109:web:c42e1a3ef68b5e6529a08c"
};
const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const controls = document.getElementById('controls');
const switchBtn = document.getElementById('switchBtn');
const snapBtn = document.getElementById('snapBtn');
const thumbs = document.getElementById('thumbs');
const selects = document.getElementById('selects');
const makeStrip = document.getElementById('makeStrip');
const strip = document.getElementById('strip');
const qrBtn = document.getElementById('qrBtn');
const qrWrap = document.getElementById('qrWrap');
const qrCanvas = document.getElementById('qrcodeCanvas');
const downloadBtn = document.getElementById('downloadBtn');
const shotsTitle = document.getElementById('shotsTitle');
const selectTitle = document.getElementById('selectTitle');

let stream = null;
let facingMode = 'user';
let shots = [];
let selected = [];

// ì¹´ë©”ë¼ ì‹œì‘
async function startCamera() {
  try {
    if (stream) stream.getTracks().forEach(t => t.stop());

    const constraints = { video: { facingMode } };

    stream = await navigator.mediaDevices.getUserMedia(constraints)
      .catch(async () => await navigator.mediaDevices.getUserMedia({ video: true }));

    video.srcObject = stream;
    await video.play();
    console.log("âœ… ì¹´ë©”ë¼ ì‹œì‘ë¨");

    // UI ì „í™˜
    startBtn.style.display = "none";
    video.style.display = "block";
    controls.style.display = "flex";
    shotsTitle.style.display = "block";
    selectTitle.style.display = "block";
    makeStrip.style.display = "inline-block";
    qrWrap.style.display = "flex";

  } catch (e) {
    alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + e.message);
    console.error(e);
  }
}

// ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë©”ë¼ ì‹¤í–‰ (iOS Safari í•„ìˆ˜)
startBtn.addEventListener("click", async () => {
  await startCamera();
});

// ì¹´ë©”ë¼ ì „í™˜
switchBtn.addEventListener('click', async ()=>{ 
  facingMode = facingMode==='user'?'environment':'user'; 
  await startCamera(); 
});

// ì‚¬ì§„ ì°ê¸°
snapBtn.addEventListener('click', ()=>{
  if(shots.length>=6){alert("ìµœëŒ€ 6ì¥"); return;}
  if(video.readyState<2){alert("ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘"); return;}

  const c = document.createElement('canvas');
  c.width = video.videoWidth || 640;
  c.height = video.videoHeight || 480;
  const ctx = c.getContext('2d');
  ctx.drawImage(video, 0, 0, c.width, c.height);
  const dataUrl = c.toDataURL('image/png');

  shots.push(dataUrl);
  const img = document.createElement('img');
  img.src = dataUrl;
  thumbs.appendChild(img);
  img.addEventListener('click', ()=> selectPhoto(dataUrl, img));
});

// ì‚¬ì§„ ì„ íƒ
function selectPhoto(dataUrl, imgEl){
  if(selected.includes(dataUrl)){
    selected = selected.filter(d=>d!==dataUrl);
    imgEl.classList.remove('selected');
  } else {
    if(selected.length>=4){alert("4ì¥ë§Œ ì„ íƒ"); return;}
    selected.push(dataUrl);
    imgEl.classList.add('selected');
  }
  renderSelected();
}
function renderSelected(){
  selects.innerHTML='';
  selected.forEach(url=>{ const im=document.createElement('img'); im.src=url; selects.appendChild(im); });
}

// 2x2 ìŠ¤íŠ¸ë¦½ ìƒì„±
makeStrip.addEventListener('click', async ()=>{
  if(selected.length!==4){alert("4ì¥ ì„ íƒ");return;}
  const side=200, gap=10;
  strip.width = side*2 + gap;
  strip.height = side*2 + gap;
  const ctx = strip.getContext('2d');
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,strip.width,strip.height);

  for(let i=0;i<4;i++){
    await new Promise(resolve=>{
      const img=new Image();
      img.src=selected[i];
      img.onload = ()=>{
        const x=(i%2)*(side+gap);
        const y=Math.floor(i/2)*(side+gap);
        ctx.drawImage(img,x,y,side,side);
        resolve();
      }
    });
  }
  strip.style.display='block';
  downloadBtn.style.display='block';
});

// Blob ë³€í™˜
function dataURLtoBlob(dataurl){
  const arr=dataurl.split(','), mime=arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n=bstr.length;
  const u8arr = new Uint8Array(n);
  while(n--){u8arr[n]=bstr.charCodeAt(n);}
  return new Blob([u8arr], {type:mime});
}

// Firebase ì—…ë¡œë“œ
async function uploadImage(blob, filename="photobooth.png"){
  const fileRef = ref(storage, `photobooth/${Date.now()}_${filename}`);
  await uploadBytes(fileRef, blob);
  return await getDownloadURL(fileRef);
}

// QR ìƒì„±
qrBtn.addEventListener('click', async ()=>{
  const blob = dataURLtoBlob(strip.toDataURL("image/png"));
  const url = await uploadImage(blob);
  QRCode.toCanvas(qrCanvas, url, {width:200}, err=>{if(err)console.error(err)});
});

// ë‹¤ìš´ë¡œë“œ
downloadBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = strip.toDataURL("image/png");
  a.download = "photobooth.png";
  a.click();
});
</script>
</body>
</html>
