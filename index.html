<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iOS 안전 인생네컷</title>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:16px}
video{width:100%;max-width:400px;border-radius:12px;background:#000}
canvas{display:block;width:100%;max-width:400px;margin:12px 0;border-radius:12px;background:#fff}
.controls,.thumbs,.selects,.qr-wrap{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
button{padding:8px 12px;border:0;border-radius:8px;font-size:16px}
button.primary{background:#ffd166;color:#111;font-weight:600}
.thumbs img,.selects img{width:70px;height:70px;object-fit:cover;border:2px solid transparent;border-radius:6px;cursor:pointer}
.selected{border-color:#ffd166}
#qrcodeCanvas{background:#fff;padding:4px;border-radius:6px}
</style>
</head>
<body>

<h2>iOS 안전 인생네컷</h2>
<video id="video" autoplay playsinline muted></video>
<div class="controls">
  <button id="switchBtn">카메라 전환</button>
  <button id="snapBtn" class="primary">촬영</button>
</div>

<h3>찍은 사진 (최대 6장)</h3>
<div class="thumbs" id="thumbs"></div>

<h3>선택한 4장</h3>
<div class="selects" id="selects"></div>
<button id="makeStrip" class="primary" style="margin-top:8px">네컷 만들기</button>

<canvas id="strip" style="display:none"></canvas>

<div class="qr-wrap" style="margin-top:12px">
  <button id="qrBtn">QR 받기</button>
  <canvas id="qrcodeCanvas"></canvas>
</div>

<button id="downloadBtn" class="primary" style="margin-top:12px;display:none">다운로드</button>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
(async()=>{
const video=document.getElementById('video');
const switchBtn=document.getElementById('switchBtn');
const snapBtn=document.getElementById('snapBtn');
const thumbs=document.getElementById('thumbs');
const selects=document.getElementById('selects');
const makeStrip=document.getElementById('makeStrip');
const strip=document.getElementById('strip');
const qrBtn=document.getElementById('qrBtn');
const qrCanvas=document.getElementById('qrcodeCanvas');
const downloadBtn=document.getElementById('downloadBtn');

let stream=null;
let facingMode='user';
let shots=[]; // 최대 6장
let selected=[];

// 카메라 시작
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facingMode}});
    video.srcObject=stream;
  }catch(e){
    alert('카메라 접근 실패: '+e.message);
  }
}
switchBtn.addEventListener('click',async()=>{
  facingMode=facingMode==='user'?'environment':'user';
  await startCamera();
});

// 촬영
snapBtn.addEventListener('click',()=>{
  if(shots.length>=6){alert("최대 6장까지 찍을 수 있어요");return;}
  if(video.readyState<2){alert("카메라 준비 중입니다. 잠시만 기다려주세요");return;}
  const c=document.createElement('canvas');
  const side=Math.min(video.videoWidth,video.videoHeight);
  c.width=c.height=side;
  const ctx=c.getContext('2d');
  ctx.drawImage(video,(video.videoWidth-side)/2,(video.videoHeight-side)/2,side,side,0,0,side,side);
  const dataUrl=c.toDataURL('image/png');
  shots.push(dataUrl);

  const img=document.createElement('img');
  img.src=dataUrl;
  thumbs.appendChild(img);
  img.addEventListener('click',()=>selectPhoto(dataUrl,img));
});

// 사진 선택
function selectPhoto(dataUrl,imgEl){
  if(selected.includes(dataUrl)){
    selected=selected.filter(d=>d!==dataUrl);
    imgEl.classList.remove('selected');
  }else{
    if(selected.length>=4){alert("4장만 선택할 수 있어요");return;}
    selected.push(dataUrl);
    imgEl.classList.add('selected');
  }
  renderSelected();
}
function renderSelected(){
  selects.innerHTML='';
  selected.forEach(url=>{
    const im=document.createElement('img');im.src=url;selects.appendChild(im);
  });
}

// 네컷 만들기 (Promise로 순서 보장)
makeStrip.addEventListener('click',async()=>{
  if(selected.length!==4){alert("4장을 선택하세요");return;}
  const side=400;
  strip.width=side;
  strip.height=side*4+10*3;
  const ctx=strip.getContext('2d');
  ctx.fillStyle='#fff';
  ctx.fillRect(0,0,strip.width,strip.height);

  for(let i=0;i<selected.length;i++){
    await new Promise(resolve=>{
      const img=new Image();
      img.src=selected[i];
      img.onload=()=>{ctx.drawImage(img,0,i*(side+10),side,side);resolve();}
    });
  }
  strip.style.display='block';
  downloadBtn.style.display='block';
});

// QR 코드 생성
qrBtn.addEventListener('click',()=>{
  const dataUrl=strip.toDataURL("image/png");
  QRCode.toCanvas(qrCanvas,dataUrl,{width:200},err=>{if(err)console.error(err)});
});

// 다운로드
downloadBtn.addEventListener('click',()=>{
  const a=document.createElement('a');
  a.href=strip.toDataURL("image/png");
  a.download="photobooth.png";
  a.click();
});

await startCamera();
})();
</script>
</body>
</html>
